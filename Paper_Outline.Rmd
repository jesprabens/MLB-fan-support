---
title: "Modeling Bandwagoning and Hype in the MLB"
author: "Jake Esprabens and Kelly Bodwin"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
library(tidyverse)
library(gtrendsR)
```

[Abstract]
“Hopping on the bandwagon” is a familiar phrase used to describe a person that 
follows a trend, believes in an idea, or supports a team solely because it is 
becoming popular. The bandwagon effect is very common when describing fans in 
professional sports, including Major League Baseball. (Talk about Past Bandwagon 
Studies?) In this work, we model the Google search hits for MLB teams across a 
season as a function of team success.  Using a hierarchical time series model, we 
are able to explorewhich MLB teams attract the most “bandwagon” fans and when MLB 
teams are overhypedor underhyped. We defined a “hype” moment as an unusual spike 
in Google searches at a specific time for a team.  The creation of this model 
required gathering the Google search hits data from Google Trends for each MLB 
team and collecting other baseball-related data to be used as exogenous 
variables. (...More Model Building) (...Results and Conclusion)

# Introduction

[General Stuff about bandwagoning]

The term "Bandwagon" is used in professional sports to refer to fans suddenly
showing interest in a team when that team achieves success - i.e., "jumping on 
the bandwagon" of the team.  ...


In this paper, we establish a hierarchical time series model that borrows across
data from all 30 MLB teams to predict internet search volume for a given team
in a given month.  We use these models to address the following questions:

1. Which MLB teams are more or less prone overall to attracting bandwagon fans?

2. When in recent MLB history were there periods of overhype or underhype for a
particular team?

## The Data

[where did we get it, etc]

[small table snippet of dataset]

Fig 1.

```{r}
fig1_dat <- read.csv("combined_data.csv") %>%
  mutate(date = as.Date(date)) %>%
  filter(team == "Los Angeles Dodgers" | team == "San Francisco Giants")
        

fig1_dat %>%
  ggplot(aes(x = as.Date(date), y = googlehits, group = team)) + 
  geom_line(aes(color = team)) + 
  labs(title="Google Trend of LA Dodgers and SF Giants", x = "Date", y = "Google Hits") + 
  scale_color_manual(values=c("dodgerblue", "darkorange")) +
  theme_minimal()+
  annotate(geom="text",x=as.Date("2012-10-01"), y=33,label="SF Giants", col = "darkorange", fontface = "bold", size = 3.5) + 
  annotate(geom="text",x=as.Date("2017-01-01"), y=52,label="LA Dodgers", col = "dodgerblue", fontface = "bold", size = 3.5) + 
  theme(legend.position = "none",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        # panel.grid.minor.y = element_blank(),
        panel.border = element_rect(colour = "gray85", fill = NA))
```

[Brief discussion: note how there are consistent phases of the season, 
but success strongly determines size of spike; e.g. Giants won in X years, 
Dodgers won in Y years]

### Google Trends Scaling

[The problem of how gtrends reports relative to max value]

Fig 2.

```{r}
fig2a_dat <- gtrends(keyword = c("%2Fm%2F04mjl", "%2Fm%2F0713r"),geo = "US", time = "all")$interest_over_time %>%
  mutate(team = keyword,
         googlehits = hits,
         team = (gsub("%2Fm%2F04mjl","Los Angeles Dodgers", team)),
         team = (gsub("%2Fm%2F0713r","San Francisco Giants", team))) %>%
  select(date, googlehits, team)
         


fig2a_dat %>%
  ggplot(aes(x = as.Date(date), y = googlehits, group = team)) + 
  geom_line(aes(color = team)) + 
  theme_minimal() +
  labs(title="Google Trend of LA Dodgers and SF Giants", x = "Date", y = "Google Hits") + 
  scale_color_manual(values=c("dodgerblue", "darkorange")) +
  annotate(geom="text",x=as.Date("2012-10-01"), y=45,label="SF Giants", col = "darkorange", fontface = "bold", size = 3.5) + 
  annotate(geom="text",x=as.Date("2017-01-01"), y=80,label="LA Dodgers", col = "dodgerblue", fontface = "bold", size = 3.5) + 
  theme(legend.position = "none",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.border = element_rect(colour = "gray85", fill = NA))
```

```{r}
fig2b_dat <- gtrends(keyword = c("%2Fm%2F04mjl", "%2Fm%2F01yjl"),geo = "US", time = "all")$interest_over_time %>%
  mutate(team = keyword,
         googlehits = hits,
         team = (gsub("%2Fm%2F04mjl","Los Angeles Dodgers", team)),
         team = (gsub("%2Fm%2F01yjl","Chicago Cubs", team))) %>%
  select(date, googlehits, team)
         


fig2b_dat %>%
  ggplot(aes(x = as.Date(date), y = googlehits, group = team)) + 
  geom_line(aes(color = team)) + 
  theme_minimal() +
  labs(title="Google Trend of LA Dodgers and CHI Cubs", x = "Date", y = "Google Hits") + 
  scale_color_manual(values=c("firebrick2", "dodgerblue")) +
  annotate(geom="text",x=as.Date("2015-06-01"), y=50,label="CHI Cubs", col = "firebrick2", fontface = "bold", size = 3.5) + 
  annotate(geom="text",x=as.Date("2019-01-01"), y=70,label="LA Dodgers", col = "dodgerblue", fontface = "bold", size = 3.5) + 
  theme(legend.position = "none",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        # panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(colour = "gray85", fill = NA))
  
```


Through brute force exploration, we determined that the global maximum was set by
searches for the Chicago Cubs in October 2016, during their historic World Series
victory run.  Thus, data for all teams was recorded relative to this maximum;
that is, a Google Hits measurement of 68 indicates that the team was searched
68% as often as "Chicago Cubs" in October 2016.

### Quantile Normalization

Because of the unusual relative scaling of the data, and the magnitude of the
spikes in interest during the World Series, this data is very skewed.

Fig 3: Histogram of all gtrends obserations.

```{r}
fig3_dat <- read.csv("combined_data.csv")

fig3_dat %>%
  ggplot(aes(x = googlehits)) + 
  geom_histogram(bins = 20,
                 col = "azure4",
                 fill = "azure3") +
  labs(title = "Google Trend Hits for All MLB Teams", x = "Google Hits") + 
  scale_y_continuous(expand = c(0,0), limits = c(0, 4300)) +
  theme(axis.title.y=element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(colour = "gray85", fill = NA),
        panel.background = element_rect(fill = "white"),
        # plot.background = element_rect(fill = "azure3")
        ) 
```

```{r}
fig3_dat %>%
  ggplot(aes(x = log(googlehits))) + 
  geom_histogram(bins = 10,
                 col = "azure4",
                 fill = "azure3") +
  labs(title = "Log Google Trend Hits for All MLB Teams", x = "Log Google Hits") + 
  scale_y_continuous(expand = c(0,0), limits = c(0, 2200)) +
  theme(axis.title.y=element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(colour = "gray85", fill = NA),
        panel.background = element_rect(fill = "white"),
        # plot.background = element_rect(fill = "azure3")
        ) 
```


The skew is too extreme to address with any common data transformations.  However,
we assert that the raw data values are not meaningful in and of themselves, as
they correspond to an arbitrary scale set by the most publicized month of baseball
during the time window of the data collection.  Therefore, we opted for a data 
transformation that retains the rank-ordering of the observations, but not the 
scaling.  Google Hits values were quantile normalized (reference) before model building.

### Season phases

A third challenge of Google Trends as a data source is that data is aggregated
monthly.  This allows us to track some nuance in annual patterns, but not at
a game-specific level.

Instead of predicting internet search volume by month, we include in our model
a variable we call *Phase*.  The season is divided into four phases:

* *Opening*: April
* *Season*: May - Sept
* *Playoffs*: October
* *Off-Season:* Nov - March


Fig 4

```{r}
fig4_dat <- read.csv("plotting_data.csv") %>%
  mutate(date = as.Date(date))

# giants - quantile normalized hits plot for last 5 years
fig4_dat %>%
  filter(team == "San Francisco Giants",
         date <= as.Date("2020-07-01") & date >= as.Date("2015-07-01")) %>%
  ggplot(aes(x = date, y = qn_ghits)) +
  geom_line(col = "darkorange") +
  labs(title = "Quantile-Normalized Google Trend Hits for SF Giants (Past 5 Years)") + 
  theme(plot.title = element_text(face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA),
        panel.background = element_rect(fill = "gray90"),
        plot.background = element_rect(fill = "darkorange")) 

# giants - monthly average hits over ALL years with phases
fig4_dat %>%
  filter(team == "San Francisco Giants") %>% 
  group_by(month) %>%
  summarise(monthly_avg = mean(googlehits)) %>%
  ggplot(aes(x = as.factor(month), y = monthly_avg, group = 1)) +
  geom_point(col = "darkorange") +
  geom_line(col = "darkorange") + 
  geom_vline(xintercept = c(4,10), linetype = "dashed", color = "black") + 
  geom_text(aes(x=2, y=7, label = "Off-Season")) +
  geom_text(aes(x=11.5, y=7, label = "Off-Season")) +
  geom_text(aes(x=4, y=7, label = "Opening Day\n"), angle = 90) + 
  geom_text(aes(x=7, y=7, label = "Season")) + 
  geom_text(aes(x=10, y=7, label = "Post-Season\n"), angle = 90) + 
  labs(title = "Monthly Average of Google Trend Hits for SF Giants (2004 - Present)") + 
  scale_x_discrete(labels = month.abb[c(1:12)]) + 
  theme(plot.title = element_text(face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA),
        panel.background = element_rect(fill = "gray90"),
        plot.background = element_rect(fill = "darkorange")) 

```

```{r}
# Mariners - quantile normalized hits plot for last 5 years
fig4_dat %>%
  filter(team == "Seattle Mariners",
         date <= as.Date("2020-07-01") & date >= as.Date("2015-07-01")) %>%
  ggplot(aes(x = date, y = qn_ghits)) +
  geom_line(col = "cyan4") +
  labs(title = "Quantile-Normalized Google Trend Hits for SEA Mariners (Past 5 Years)") + 
  theme(plot.title = element_text(face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA),
        panel.background = element_rect(fill = "gray90"),
        plot.background = element_rect(fill = "cyan4")) 

# Mariners - monthly average hits over ALL years with phases
fig4_dat %>%
  filter(team == "Seattle Mariners") %>% 
  group_by(month) %>%
  summarise(monthly_avg = mean(googlehits)) %>%
  ggplot(aes(x = as.factor(month), y = monthly_avg, group = 1)) +
  geom_point(col = "cyan4") +
  geom_line(col = "cyan4") + 
  geom_vline(xintercept = c(4,10), linetype = "dashed", color = "black") + 
  geom_text(aes(x=2, y=2, label = "Off-Season")) +
  geom_text(aes(x=11.5, y=2, label = "Off-Season")) +
  geom_text(aes(x=4, y=2, label = "Opening Day\n"), angle = 90) + 
  geom_text(aes(x=7, y=2, label = "Season")) + 
  geom_text(aes(x=10, y=2, label = "Post-Season\n"), angle = 90) + 
  labs(title = "Monthly Average of Google Trend Hits for SEA Mariners (2004 - Present)") + 
  scale_x_discrete(labels = month.abb[c(1:12)]) + 
  theme(plot.title = element_text(face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA),
        panel.background = element_rect(fill = "gray90"),
        plot.background = element_rect(fill = "cyan4")) 

```

```{r}
# ALL TEAMS - quantile normalized hits plot for last 5 years
fig4_dat %>%
  filter(date <= as.Date("2020-07-01") & date >= as.Date("2015-07-01")) %>%
  group_by(date) %>%
  summarise(avg_qn_ghits = mean(qn_ghits)) %>%
  ggplot(aes(x = date, y = avg_qn_ghits)) +
  geom_line(col = "azure4") +
  labs(title = "Average Quantile-Normalized Google Trend Hits for MLB Teams (Past 5 Years)") + 
  theme(plot.title = element_text(face = "bold", size = 13),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA),
        panel.background = element_rect(fill = "gray90"),
        plot.background = element_rect(fill = "azure3")) 

# ALL TEAMS - monthly average hits over ALL years with phases
fig4_dat %>%
  group_by(month) %>%
  summarise(monthly_avg = mean(googlehits)) %>%
  ggplot(aes(x = as.factor(month), y = monthly_avg, group = 1)) +
  geom_point(col = "azure4") +
  geom_line(col = "azure4") + 
  geom_vline(xintercept = c(4,10), linetype = "dashed", color = "black") + 
  geom_text(aes(x=2, y=3.5, label = "Off-Season")) +
  geom_text(aes(x=11.5, y=3.5, label = "Off-Season")) +
  geom_text(aes(x=4, y=3.5, label = "Opening Day\n"), angle = 90) + 
  geom_text(aes(x=7, y=3.5, label = "Season")) + 
  geom_text(aes(x=10, y=3.5, label = "Post-Season\n"), angle = 90) + 
  labs(title = "Monthly Average of Google Trend Hits for MLB Teams (2004 - Present)") + 
  scale_x_discrete(labels = month.abb[c(1:12)]) + 
  theme(plot.title = element_text(face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA),
        panel.background = element_rect(fill = "gray90"),
        plot.background = element_rect(fill = "azure3")) 

```

## Model-Building


## Measuring hype and bandwagoning


## Conclusions


## Future Work




