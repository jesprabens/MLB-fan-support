---
title: "Modeling Bandwagoning and Hype in the MLB"
author: "Jake Esprabens and Kelly Bodwin"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
library(tidyverse)
library(gtrendsR)
```

[Abstract]
“Hopping on the bandwagon” is a familiar phrase used to describe a person that 
follows a trend, believes in an idea, or supports a team solely because it is 
becoming popular. The bandwagon effect is very common when describing fans in 
professional sports, including Major League Baseball. (Talk about Past Bandwagon 
Studies?) In this work, we model the Google search hits for MLB teams across a 
season as a function of team success.  Using a hierarchical time series model, we 
are able to explorewhich MLB teams attract the most “bandwagon” fans and when MLB 
teams are overhypedor underhyped. We defined a “hype” moment as an unusual spike 
in Google searches at a specific time for a team.  The creation of this model 
required gathering the Google search hits data from Google Trends for each MLB 
team and collecting other baseball-related data to be used as exogenous 
variables. (...More Model Building) (...Results and Conclusion)

# Introduction

[General Stuff about bandwagoning]

The term "Bandwagon" is used in professional sports to refer to fans suddenly
showing interest in a team when that team achieves success - i.e., "jumping on 
the bandwagon" of the team.  ...


In this paper, we establish a hierarchical time series model that borrows across
data from all 30 MLB teams to predict internet search volume for a given team
in a given month.  We use these models to address the following questions:

1. Which MLB teams are more or less prone overall to attracting bandwagon fans?

2. When in recent MLB history were there periods of overhype or underhype for a
particular team?

## The Data

[where did we get it, etc]

### Google hits
In order to measure the "bandwagon" level of MLB fans, we gathered data from Google Trends to depict the popularity of each team.  This data was gathered using the [**gtrendsR**](https://cran.r-project.org/web/packages/gtrendsR/gtrendsR.pdf) package, which automatically pulls the data from the [Google Trends](https://trends.google.com/trends/?geo=US) API.  The units of the Google Trend data are dependent on the maximum of all the Google searches of interest.  Therefore, we went through each team and determined that the Chicago Cubs had the maximum google trend hits; this lead us to gather data for the rest of the MLB teams relative to the Cubs.  We were also able to collect the Google search hits of the term "MLB" using Google Trends.  Moreover, it is important to note that Google Trends has only been keeping track of Google Searches since the beginning of 2004.

### Sports Betting Odds
The preseason odds dataset was gathered using data from [Sports Odds History](https://www.sportsoddshistory.com/mlb-odds/).  We compiled this data by viewing each teams' odds of winning the World Series from 2004 to the present.  Ideally, we would have like to use monthly odds of winning the World Series for each MLB team; however, this data was not available for every desired year.

### Attendance and Payroll
We decided that attendence and payroll of each team by season may be valuable exogenous variables that could help determine when fans would become bandwagons.  We gathered this data from [Baseball Reference](https://www.baseball-reference.com/leagues/MLB/2019-misc.shtml) by copying the data from each the years 2004 to 2019.

### Team Performance
Other exogenous variables we decided would be a valuable predictor in this model was win percentage and whether each team made the playoffs.  We were able to download this data directly from [Sean Lahman's Baseball Database](http://www.seanlahman.com/baseball-archive/statistics/).  This dataset was also filled with other variables such as attendance along with indicators of whether each team won their respective divisions, wild card games, leagues, and the world series.

### TV Market Size
The TV Market Size of each team was also important to create an accurate estimation of the number of true fans of each.  We were able to gather this data using the Nielsen Market Size from [Sports Media Watch](https://www.sportsmediawatch.com/nba-market-size-nfl-mlb-nhl-nielsen-ratings/).

### Postseason Performance
Postseason performance is likely to be one of the most, if not the most, valuable exogenous predictors a teams Google search hits. We manually gathered this data using the respective [Wikipedia](https://en.wikipedia.org/wiki/2019_Major_League_Baseball_season#Postseason) page for each MLB postseason.

[small table snippet of dataset]
```{r, echo = FALSE}
head(read.csv("MLB_combined.csv"), 10)
```


Fig 1.

```{r}
fig1_dat <- read.csv("combined_data.csv") %>%
  mutate(date = as.Date(date)) %>%
  filter(team == "Los Angeles Dodgers" | team == "San Francisco Giants")
        

fig1_dat %>%
  ggplot(aes(x = as.Date(date), y = googlehits, group = team)) + 
  geom_line(aes(color = team)) + 
  labs(title="Google Trend of LA Dodgers and SF Giants (2004-2020)", x = "Date", y = "Google Hits") + 
  scale_color_manual(values=c("dodgerblue", "darkorange")) +
  theme_minimal()+
  annotate(geom="text",x=as.Date("2012-10-01"), y=33,label="SF Giants", col = "darkorange", fontface = "bold", size = 3.5) + 
  annotate(geom="text",x=as.Date("2017-01-01"), y=52,label="LA Dodgers", col = "dodgerblue", fontface = "bold", size = 3.5) + 
  theme(legend.position = "none",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_line(colour = "gray92"),
        panel.grid.minor.y = element_line(colour = "gray92"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(angle = 0, vjust = 0.5),
        panel.border = element_rect(colour = "gray80", fill = NA))
```

[Brief discussion: note how there are consistent phases of the season, 
but success strongly determines size of spike; e.g. Giants won in X years, 
Dodgers won in Y years]

Here are two Google Trend lines of the San Francisco Giants and Los Angeles Dodgers from 2004 to July of 2020.  Generally, it is evident that there is seasonality.  There are often more Google search hits at the beginning of the season (April) and during the post-season (October); and expectedly, this number drastically drops during the off-season, which is from November to March.  However, there are several out-of-the-ordinary substantial spikes in the last decade for both teams.  These spikes are most strongly influenced by their playoff success.  It is important to note that the San Francisco Giants won the World Series in 2010, 2012, and 2014 while the Dodgers made the World Series in 2017 and 2018, but failed to win. This clearly aligns with these sizable spikes.


### Google Trends Scaling

[The problem of how gtrends reports relative to max value]

The Google Trends data is very useful; however, it can sometimes be hard to interpret because of the units.  Google normalizes the data by dividing each data point by the total searches of the region and time range represented.  In our case, the region is simply the United States and time varies from 2004 to 2020.  These numbers are then put on scale of 0 to 100 relative to the rest of the correponding search terms.  

To illustrate how this process works, there are two plots below: Figure 2a compares just the Los Angeles Dodgers and the San Francisco Giants while Figure 2b only compares the Los Angeles Dodgers and the Chicago Cubs.  In Figure 2a, it is evident that the Dodgers held the most Google hits in October of 2018 hence the spike reaching 100 Google hits.  Every other point is scaled relative to this maximum.  As we can see in Figure 2b, the scale will change for specific teams depending on the maximum.  In this plot, the Cubs now hold the new maximum of 100 in October 2016 because this was the first time they had won the World Series since 1908.  Therefore, they became the most googled team since 2004 resulting in the Dodgers no longer holding the maximum of 100 in this trend.

Fig 2.

```{r}
fig2a_dat <- gtrends(keyword = c("%2Fm%2F04mjl", "%2Fm%2F0713r"),geo = "US", time = "all")$interest_over_time %>%
  mutate(team = keyword,
         googlehits = hits,
         team = (gsub("%2Fm%2F04mjl","Los Angeles Dodgers", team)),
         team = (gsub("%2Fm%2F0713r","San Francisco Giants", team))) %>%
  select(date, googlehits, team)
         


fig2a_dat %>%
  ggplot(aes(x = as.Date(date), y = googlehits, group = team)) + 
  geom_line(aes(color = team)) + 
  theme_minimal() +
  labs(title="Google Trend of LA Dodgers and SF Giants (2004-2020)", x = "Date", y = "Google Hits") + 
  scale_color_manual(values=c("dodgerblue", "darkorange")) +
  annotate(geom="text",x=as.Date("2012-10-01"), y=45,label="SF Giants", col = "darkorange", fontface = "bold", size = 3.5) + 
  annotate(geom="text",x=as.Date("2017-01-01"), y=80,label="LA Dodgers", col = "dodgerblue", fontface = "bold", size = 3.5) + 
  theme(legend.position = "none",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_line(colour = "gray92"),
        panel.grid.minor.y = element_line(colour = "gray92"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(angle = 0, vjust = 0.5),
        panel.border = element_rect(colour = "gray80", fill = NA))
```

```{r}
fig2b_dat <- gtrends(keyword = c("%2Fm%2F04mjl", "%2Fm%2F01yjl"),geo = "US", time = "all")$interest_over_time %>%
  mutate(team = keyword,
         googlehits = hits,
         team = (gsub("%2Fm%2F04mjl","Los Angeles Dodgers", team)),
         team = (gsub("%2Fm%2F01yjl","Chicago Cubs", team))) %>%
  select(date, googlehits, team)
         


fig2b_dat %>%
  ggplot(aes(x = as.Date(date), y = googlehits, group = team)) + 
  geom_line(aes(color = team)) + 
  theme_minimal() +
  labs(title="Google Trend of LA Dodgers and CHI Cubs (2004-2020)", x = "Date", y = "Google Hits") + 
  scale_color_manual(values=c("firebrick2", "dodgerblue")) +
  annotate(geom="text",x=as.Date("2015-06-01"), y=50,label="CHI Cubs", col = "firebrick2", fontface = "bold", size = 3.5) + 
  annotate(geom="text",x=as.Date("2019-01-01"), y=70,label="LA Dodgers", col = "dodgerblue", fontface = "bold", size = 3.5) + 
  theme(legend.position = "none",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_line(colour = "gray92"),
        panel.grid.minor.y = element_line(colour = "gray92"),
        axis.title.y = element_text(angle = 0, vjust = 0.5),
        axis.title.x = element_blank(),
        panel.border = element_rect(colour = "gray80", fill = NA))
  
```


Through brute force exploration, we determined that the global maximum was set by
searches for the Chicago Cubs in October 2016, during their historic World Series
victory run.  Thus, data for all teams was recorded relative to this maximum;
that is, a Google Hits measurement of 68 indicates that the team was searched
68% as often as "Chicago Cubs" in October 2016.

### Quantile Normalization

Because of the unusual relative scaling of the data, and the magnitude of the
spikes in interest during the World Series, this data is very skewed.

Fig 3: Histogram of all gtrends obserations.

```{r}
fig3_dat <- read.csv("combined_data.csv")

fig3_dat %>%
  ggplot(aes(x = googlehits)) + 
  geom_histogram(bins = 20,
                 col = "azure4",
                 fill = "azure3") +
  labs(title = "Google Trend Hits for All MLB Teams", x = "Google Hits") + 
  scale_y_continuous(expand = c(0,0), limits = c(0, 4300)) +
  theme(axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "gray80", fill = NA),
        panel.background = element_rect(fill = "white")
        ) 
```

```{r}
fig3_dat %>%
  ggplot(aes(x = log(googlehits))) + 
  geom_histogram(bins = 10,
                 col = "azure4",
                 fill = "azure3") +
  labs(title = "Log Google Trend Hits for All MLB Teams", x = "Log Google Hits") + 
  scale_y_continuous(expand = c(0,0), limits = c(0, 2200)) +
  theme(axis.title.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour = "gray85", fill = NA),
        panel.background = element_rect(fill = "white")
        ) 
```


As seen in Figures 3a and 3b, the skew is too extreme to address with any common data 
transformations.  However, we assert that the raw data values are not meaningful in 
and of themselves, as they correspond to an arbitrary scale set by the most publicized 
month of baseball during the time window of the data collection.  Therefore, we opted 
for a data transformation that retains the rank-ordering of the observations, but not the 
scaling.  Google Hits values were quantile normalized (reference) before model building.

### Season phases

A third challenge of Google Trends as a data source is that data is aggregated
monthly.  This allows us to track some nuance in annual patterns, but not at
a game-specific level.

Instead of predicting internet search volume by month, we include in our model
a variable we call *Phase*.  The season is divided into four phases:

* *Opening*: April
* *Season*: May - Sept
* *Playoffs*: October
* *Off-Season:* Nov - March


Fig 4

```{r}
fig4_dat <- read.csv("plotting_data.csv") %>%
  mutate(date = as.Date(date))

# giants - quantile normalized hits plot for last 5 years
fig4_dat %>%
  filter(team == "San Francisco Giants",
         date <= as.Date("2020-07-01") & date >= as.Date("2015-07-01")) %>%
  ggplot(aes(x = date, y = qn_ghits)) +
  geom_line(col = "darkorange") +
  labs(title = "Quantile-Normalized Google Trend Hits for SF Giants (Past 5 Years)") + 
  theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_line(colour = "gray92"),
        panel.grid.minor.y = element_line(colour = "gray92"),
        panel.border = element_rect(colour = "gray80", fill = NA),
        panel.background = element_rect(fill = "white")
  )

# giants - monthly average hits over ALL years with phases
fig4_dat %>%
  filter(team == "San Francisco Giants") %>% 
  group_by(month) %>%
  summarise(monthly_avg = mean(googlehits)) %>%
  ggplot(aes(x = as.factor(month), y = monthly_avg, group = 1)) +
  geom_point(col = "darkorange") +
  geom_line(col = "darkorange") + 
  geom_vline(xintercept = c(4,10), linetype = "dashed", color = "black") + 
  annotate(geom = "text", x=2, y=6.5, label = "Off-Season") +
  annotate(geom = "text", x=4, y=6.5, label = "Opening Day\n", angle = 90) + 
  annotate(geom = "text", x=7, y=6.5, label = "Season") +
  annotate(geom = "text", x=10, y=6.5, label = "Post-Season\n", angle = 90) +
  annotate(geom = "text", x=11.5, y=6.5, label = "Off-Season") +
  labs(title = "Monthly Average Google Trend Hits for SF Giants (2004-2020)") + 
  scale_x_discrete(labels = month.abb[c(1:12)]) + 
  scale_y_continuous(expand = c(0,0), limits = c(0,10)) + 
  theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(colour = "gray92"),
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(colour = "gray80", fill = NA),
        panel.background = element_rect(fill = "white")
  )

```

```{r}
# Mariners - quantile normalized hits plot for last 5 years
fig4_dat %>%
  filter(team == "Seattle Mariners",
         date <= as.Date("2020-07-01") & date >= as.Date("2015-07-01")) %>%
  ggplot(aes(x = date, y = qn_ghits)) +
  geom_line(col = "cyan4") +
  labs(title = "Quantile-Normalized Google Trend Hits for SEA Mariners (Past 5 Years)") + 
  theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_line(colour = "gray92"),
        panel.grid.minor.y = element_line(colour = "gray92"),
        panel.border = element_rect(colour = "gray80", fill = NA),
        panel.background = element_rect(fill = "white")
        )  

# Mariners - monthly average hits over ALL years with phases
fig4_dat %>%
  filter(team == "Seattle Mariners") %>% 
  group_by(month) %>%
  summarise(monthly_avg = mean(googlehits)) %>%
  ggplot(aes(x = as.factor(month), y = monthly_avg, group = 1)) +
  geom_point(col = "cyan4") +
  geom_line(col = "cyan4") + 
  geom_vline(xintercept = c(4,10), linetype = "dashed", color = "black") + 
  annotate(geom = "text", x=2, y=1.75, label = "Off-Season") +
  annotate(geom = "text", x=4, y=1.75, label = "Opening Day\n", angle = 90) + 
  annotate(geom = "text", x=7, y=1.75, label = "Season") +
  annotate(geom = "text", x=10, y=1.75, label = "Post-Season\n", angle = 90) +
  annotate(geom = "text", x=11.5, y=1.75, label = "Off-Season") +
  labs(title = "Monthly Average Google Trend Hits for SEA Mariners (2004-2020)") + 
  scale_x_discrete(labels = month.abb[c(1:12)]) + 
  scale_y_continuous(expand = c(0,0), limits = c(0,4)) +
  theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(colour = "gray92"),
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(colour = "gray80", fill = NA),
        panel.background = element_rect(fill = "white")
        ) 

```

```{r}
# ALL TEAMS - quantile normalized hits plot for last 5 years
fig4_dat %>%
  filter(date <= as.Date("2020-07-01") & date >= as.Date("2015-07-01")) %>%
  group_by(date) %>%
  summarise(avg_qn_ghits = mean(qn_ghits)) %>%
  ggplot(aes(x = date, y = avg_qn_ghits)) +
  geom_line(col = "azure4") +
  labs(title = "Average Quantile-Normalized Google Trend Hits for MLB Teams (Past 5 Years)") + 
  theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_line(colour = "gray92"),
        panel.grid.minor.y = element_line(colour = "gray92"),
        panel.border = element_rect(colour = "gray80", fill = NA),
        panel.background = element_rect(fill = "white")
        ) 

# ALL TEAMS - monthly average hits over ALL years with phases
fig4_dat %>%
  group_by(month) %>%
  summarise(monthly_avg = mean(googlehits)) %>%
  ggplot(aes(x = as.factor(month), y = monthly_avg, group = 1)) +
  geom_point(col = "azure4") +
  geom_line(col = "azure4") + 
  geom_vline(xintercept = c(4,10), linetype = "dashed", color = "black") + 
  annotate(geom = "text", x=2, y=2.5, label = "Off-Season") +
  annotate(geom = "text", x=4, y=2.5, label = "Opening Day\n", angle = 90) + 
  annotate(geom = "text", x=7, y=2.5, label = "Season") +
  annotate(geom = "text", x=10, y=2.5, label = "Post-Season\n", angle = 90) +
  annotate(geom = "text", x=11.5, y=2.5, label = "Off-Season") +
  labs(title = "Monthly Average Google Trend Hits for MLB Teams (2004-2020)") + 
  scale_x_discrete(labels = month.abb[c(1:12)]) + 
  scale_y_continuous(expand = c(0,0), limits = c(0, 5.5)) +
  theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(colour = "gray92"),
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(colour = "gray80", fill = NA),
        panel.background = element_rect(fill = "white")
        ) 

```

MLB teams that have done well since 2004, like the San Francisco Giants, will typically have higher quantile-normalized Google trend hits over the past 5 years than the average MLB team.  Moreover, the Giants had a higher monthly average Google hits than the average team; they even had higher spikes during the post-season because they were very successful during this time.  On the other hand, an MLB team who is less successful, such as the Seattle Mariners, will have lower quantile-normalized Google trends over the past 5 years and a lower monthly average Google hits than the average team.  The Mariners monthly average Google hits also severely drops during the post-season; a large contribution to this is that they have never made the World Series. 


## Model-Building

<<<<<<< HEAD
As mentioned, the data was quantile-normaized before construction of the model began.  
=======
(motivation for hierarchical model)
>>>>>>> 275f7a8f42a6ea1d64084bd2079cd9b02c1541f2

(for sections below, provide discussion of model in words, and summary of model results)

### Level 1: Overall predicted mean


$$\{\text{Mean google hits overall} \} \sim \{\text{Mean google hits for all teams} \} + \alpha \, \text{\{TV Market Size\}} + \epsilon_{i}$$

### Level 2: Annual predicted mean

$$\{\text{Mean google hits this year} \} \sim 
\{\text{Mean google hits overall} \} + 
\gamma_0 \{\text{MLB google hits this year}\} + 
\gamma_{1} \{\text{Mean google hits last year}\} +
\gamma_{2} \{\text{Playoffs last year}\} +
\gamma_{3} \{\text{Win percent last year}\} +
\gamma_{4} \{\text{Preseason odds}\} +
\gamma_{5} \{\text{Preseason payroll}\} +
\epsilon_{ij}
\; $$

### Level 3: Predicted Google hits by month


## Results

(A few plots and discussion of how well the model fits)

## Measuring bandwagoning


## Conclusions


## Future Work




